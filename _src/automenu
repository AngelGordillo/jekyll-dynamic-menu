{% assign pass_stash = pass_active %}
{% assign pass_active = false %}
{% capture menu_inside %}
    {% for node in site.pages %}
        {% comment %}
            The main difference between datamenu and automenu is that automenu (By
            virtue of it generating the menu automatically) doesn't know ahead of
            time what it's children are.

            Because of that, this entire first part is dedicated to looping
            through *all* pages and filtering out the ones that are not
            children of the current node.

            We also have to take special care with the "/" page as this could
            result in infinite recursion.
        {% endcomment %}

        {% unless node.title %}
            {% continue %}
        {% endunless %}

        {% assign url_start = node.url | truncate: include.url.size, "" %}
        {% unless include.url == url_start %}
            {% continue %}
        {% endunless %}

        {% assign url_rest = node.url | remove_first: url_start %}
        {% assign url_rest_size = url_rest | split: "/" | size %}
        {% assign lastchar = node.url | split: "" | last %}
        {% assign nexturl = node.url %}

        {% if url_rest_size == 0 %}
            {% unless include.url == "/" %}
                {% continue %}
            {% endunless %}
        {% elsif lastchar == "/" %}
            {% unless url_rest_size == 1 %}
                {% continue %}
            {% endunless %}
        {% elsif url_rest_size == 2 %}
            {% assign filename = url_rest | split: "/" | last %}
            {% assign checkindex = filename | truncate: 6, "" %}
            {% unless checkindex == "index." %}
                {% continue %}
            {% endunless %}
            {% assign nexturl = node.url.size | minus: filename.size %}
            {% assign nexturl = node.url | truncate: nexturl, "" %}
        {% else %}
            {% continue %}
        {% endif %}

        {% assign retval = false %}
        {% assign childmenu = "" %}

        {% unless node.url == "/" %}
            {% capture childmenu %}{% include automenu url=nexturl %}{% endcapture %}
        {% endunless %}

        {% capture classes %}
            {% if page.url == node.url %}
                selected {{ " " }}
            {% elsif retval %}
                active {{ " " }}
            {% endif %}

            {% if childmenu != "" %}
                branch {{ " " }}
                {% if retval or page.url == node.url or site.menu_show_all %}
                    open
                {% else %}
                    closed
                {% endif %}
            {% else %}
                leaf
            {% endif %}
        {% endcapture %}

        <li class="{{ classes }}"><a href="{{ site.baseurl }}{{node.url}}">{{ node.title | escape }}</a>
        {% if retval or page.url == node.url or site.menu_show_all %}{{childmenu}}{% endif %}
        {% if retval or page.url == node.url %}{% assign pass_active = true %}{% endif %}
        </li>
    {% endfor %}
{% endcapture %}
{% unless menu_inside == "" %}
    <ul class="menu">
        {{ menu_inside }}
    </ul>
{% endunless %}
{% assign retval = pass_active %}
{% assign pass_active = pass_stash %}
